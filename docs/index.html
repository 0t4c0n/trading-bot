<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minervini SEPA - Top Stage 2 Stocks</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f4f7f9;
            min-height: 100vh;
            padding: 10px;
            color: #333;
        }
        
        .container {
            max-width: 500px;
            margin: 10px auto;
            background: #f4f7f9;
            border-radius: 20px;
            overflow: hidden;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 15px;
        }
        
        .header h1 {
            font-size: 1.4em;
            font-weight: 700;
            color: #1a202c;
        }
        
        .header .subtitle {
            color: #4a5568;
            font-size: 0.9em;
            font-weight: 500;
        }
        
        .summary {
            padding: 0;
            margin-bottom: 15px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            text-align: center;
        }
        
        .summary-item {
            background: #ffffff;
            padding: 12px 5px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .summary-number {
            font-size: 1.4em;
            font-weight: 700;
            color: #1a202c;
        }
        
        .summary-number.stage2 {
            color: #16a34a;
        }
        
        .summary-number.score {
            color: #2563eb;
        }
        
        .summary-number.success {
            color: #d97706;
        }
        
        .summary-label {
            font-size: 0.75em;
            color: #4a5568;
            margin-top: 4px;
            font-weight: 500;
        }
        
        .breadth-value.strong {
            color: #16a34a;
        }
        
        .breadth-value.neutral {
            color: #d97706;
        }
        
        .breadth-value.weak {
            color: #b91c1c;
        }

        .market-breadth {
            margin-bottom: 15px;
        }

        .breadth-grid {
            display: grid; /* Se ajustará a 2 columnas */
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .breadth-item {
            background: #ffffff;
            padding: 12px 5px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            text-align: center;
        }

        .breadth-value {
            font-size: 1.3em;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 4px;
        }

        .top-picks {
            padding: 0;
        }
        
        .section-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1a202c;
            display: flex;
            align-items: center;
            padding: 0 5px;
        }
        
        .stock-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease-in-out;
            position: relative;
        }
        
        .stock-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            border-color: #3b82f6;
        }
        
        /* Añade espacio a la derecha para el precio solo si la tarjeta tiene la insignia "All Filters" */
        .stock-card.has-badge .stock-price {
            padding-right: 95px;
        }
        
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        /* Añade padding a la izquierda para dejar espacio al número del ranking */
        .stock-info {
            padding-left: 30px;
        }

        .stock-info h3 {
            font-size: 1.2em;
            font-weight: 700;
            color: #1a202c;
        }
        
        .stock-info .company {
            font-size: 0.8em;
            color: #4a5568;
            font-weight: 500;
        }
        
        .stock-info .sector {
            font-size: 0.75em;
            color: #718096;
        }
        
        .stock-price {
            text-align: right;
            flex-shrink: 0;
            margin-left: 10px;
            /* El padding-right se añade dinámicamente con la clase .has-badge */
        }
        
        .price {
            font-size: 1.2em;
            font-weight: 700;
            color: #1a202c;
        }
        
        .minervini-score {
            font-size: 0.9em;
            color: #16a34a;
            font-weight: 600;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .stat-item {
            background-color: #f8fafc;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stage-badge {
            font-size: 0.85em;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 3px;
        }
        
        .stat-label {
            font-size: 0.7em;
            color: #4a5568;
            font-weight: 500;
        }
        
        .technical-indicators {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .indicator-badge {
            background: #eef2ff;
            color: #4338ca;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .indicator-badge.vcp-badge {
            background: #dcfce7; /* Verde claro */
            color: #166534; /* Verde oscuro */
            border: 1px solid #86efac;
            font-weight: 700;
        }

        .indicator-badge.accumulation-badge {
            background-color: #e0f2fe; /* Azul claro */
            color: #0c4a6e; /* Azul oscuro */
            border-color: #7dd3fc;
        }
        
        .entry-signal {
            margin-top: 12px;
            padding: 8px 12px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 0.85em;
            border: 1px solid transparent;
        }

        .entry-signal.pivot-point {
            background-color: #dcfce7; /* Verde claro */
            color: #166534; /* Verde oscuro */
            border-color: #86efac;
        }

        .entry-signal.vcp-setup {
            background-color: #fef9c3; /* Amarillo claro */
            color: #854d0e; /* Amarillo oscuro */
            border-color: #fde047;
            font-weight: 600;
        }

        .entry-signal.ma-bounce-50,
        .entry-signal.ma-bounce-21 {
            background-color: #e0f2fe; /* Azul claro */
            color: #0c4a6e; /* Azul oscuro */
            border-color: #7dd3fc;
        }

        .entry-signal.consolidando {
            background-color: #fefce8; /* Amarillo claro */
            color: #854d0e; /* Amarillo oscuro */
        }

        .entry-signal.extendido {
            background-color: #fef2f2; /* Rojo claro */
            color: #b91c1c; /* Rojo oscuro */
        }

        .rank {
            position: absolute;
            top: 15px; /* Alineado con el contenido */
            left: 15px;  /* Dentro de la tarjeta */
            background: #2563eb;
            color: white;
            padding: 3px 8px;
            border-radius: 5px;
            font-weight: 700;
            font-size: 0.75em;
            box-shadow: 2px 2px 8px rgba(37, 99, 235, 0.4);
        }
        
        .perfect-candidate-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(45deg, #16a34a, #22c55e);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(22, 163, 74, 0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            text-align: center;
        }
        
        .last-update {
            text-align: center;
            padding: 20px;
            font-size: 0.8em;
            color: #718096;
            font-weight: 500;
            line-height: 1.5;
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ffffff;
            color: white;
            background: #2563eb;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .refresh-btn:hover {
            transform: scale(1.1);
        }
        
        .no-results {
            text-align: center;
            padding: 30px 20px;
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin: 10px 0;
        }
        
        .no-results-icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.7;
        }
        
        .no-results-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #1a202c;
            margin-bottom: 8px;
        }
        
        .no-results-subtitle {
            font-size: 1em;
            color: #6c757d;
            margin-bottom: 25px;
        }
        
        .minervini-criteria {
            background: #f8fafc;
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .criteria-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.1em;
        }
        
        .criteria-section {
            margin-bottom: 15px;
        }
        
        .criteria-subtitle {
            font-weight: bold;
            color: #16a34a;
            margin-bottom: 8px;
            font-size: 0.85em;
        }
        
        .criteria-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 4px;
        }
        
        .criteria-item {
            background: #ffffff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.8em;
            border-left: 3px solid #16a34a;
        }
        
        .market-health {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .chart-container {
            display: flex;
            gap: 5px;
            height: 100px;
            align-items: flex-end;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .chart-bar {
            flex-grow: 1;
            background-color: #ccc;
            text-align: center;
            position: relative;
            border-radius: 4px 4px 0 0;
        }

        .bar-label {
            position: absolute;
            bottom: -20px;
            width: 100%;
            font-size: 0.7em;
            color: #4a5568;
            font-weight: 500;
        }
        
        .bar-value {
            font-size: 0.8em;
            font-weight: 600;
            color: white;
        }
        @media (max-width: 480px) {
            .container {
                margin: 0;
                padding: 5px;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title-section">
                <h1>📈 Minervini SEPA</h1>
                <div class="subtitle">Top Stage 2 Stocks</div>
            </div>
        </div>
        
        <div id="content">
            <div class="loading">
                <div>🔄 Cargando datos Minervini...</div>
            </div>
        </div>
    </div>
    
    <button class="refresh-btn" onclick="loadData()" title="Actualizar datos">
        🔄
    </button>

    <script>
        async function loadData() {
            const contentEl = document.getElementById('content');
            contentEl.innerHTML = `<div class="loading"><div>🔄 Cargando datos Minervini...</div></div>`;

            try {
                const response = await fetch(`data.json?v=${new Date().getTime()}`);
                if (!response.ok) {
                    throw new Error(`Error de red: ${response.statusText}`);
                }
                const data = await response.json();
                renderDashboard(data);
            } catch (error) {
                console.error('Error al cargar data.json:', error);
                contentEl.innerHTML = `<div class="error">❌ No se pudieron cargar los datos. Revisa la consola para más detalles.</div>`;
            }
        }

        function renderDashboard(data) {
            const contentEl = document.getElementById('content');

            const summaryHtml = `
                <div class="summary">
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-number">${data.summary.total_analyzed}</div>
                            <div class="summary-label">Analizadas</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number stage2">${data.summary.stage2_stocks}</div>
                            <div class="summary-label">Stage 2</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number score">${data.summary.avg_minervini_score.toFixed(1)}</div>
                            <div class="summary-label">Score Avg</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number success">${data.summary.success_rate.toFixed(1)}%</div>
                            <div class="summary-label">Éxito</div>
                        </div>
                    </div>
                </div>
            `;

            function getBreadthClass(value, thresholds) {
                if (value >= thresholds.strong) return 'strong';
                if (value >= thresholds.neutral) return 'neutral';
                return 'weak';
            }

            let marketBreadthHtml = '';
            const marketAnalysis = data.market_analysis;
            if (marketAnalysis && marketAnalysis.pct_above_ma200 !== undefined) {
                const maClass = getBreadthClass(marketAnalysis.pct_above_ma200, { strong: 60, neutral: 40 });
                const rsClass = getBreadthClass(marketAnalysis.pct_rs_strong, { strong: 50, neutral: 30 });
                const stage2Class = getBreadthClass(marketAnalysis.pct_in_stage2, { strong: 20, neutral: 10 });

                marketBreadthHtml = `
                    <div class="market-breadth">
                        <div class="section-title">🌡️ Amplitud del Mercado</div>
                        <div class="breadth-grid">
                            <div class="breadth-item">
                                <div class="breadth-value ${maClass}">${marketAnalysis.pct_above_ma200.toFixed(0)}%</div>
                                <div class="summary-label">> MA200</div>
                            </div>
                            <div class="breadth-item">
                                <div class="breadth-value ${rsClass}">${marketAnalysis.pct_rs_strong.toFixed(0)}%</div>
                                <div class="summary-label">RS > 70</div>
                            </div>
                            <div class="breadth-item">
                                <div class="breadth-value ${stage2Class}">${marketAnalysis.pct_in_stage2.toFixed(0)}%</div>
                                <div class="summary-label">in Stage 2</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            let topPicksHtml = `
                <div class="top-picks">
                    <div class="section-title">${data.top_picks.length > 0 ? '🏆 Top Picks Minervini SEPA' : 'Análisis del Mercado'}</div>
            `;

            if (data.top_picks && data.top_picks.length > 0) {
                data.top_picks.forEach(stock => {
                    const passesAll = stock.stage_analysis.passes_all_filters;
                    const cardClass = passesAll ? 'has-badge' : ''; /* Clase para CSS condicional */
                    const perfectBadge = passesAll ? '<div class="perfect-candidate-badge">✅ All Filters</div>' : '';
                    
                    // Lógica de indicadores mejorada para distinguir VCP de solo acumulación
                    let indicatorsHtml = '';
                    if (stock.technical_indicators.vcp_detected) {
                        indicatorsHtml += '<span class="indicator-badge vcp-badge">⚡ VCP Pattern</span>';
                    } else if (stock.technical_indicators.institutional_accumulation) {
                        indicatorsHtml += '<span class="indicator-badge accumulation-badge">🏦 Accumulation</span>';
                    }

                    // Otros indicadores independientes
                    if (stock.technical_indicators.institutional_evidence) indicatorsHtml += '<span class="indicator-badge">Institutional ✓</span>';
                    if (stock.fundamental_metrics.earnings_acceleration) indicatorsHtml += '<span class="indicator-badge">Earnings+</span>';
                    if (stock.fundamental_metrics.roe_strong) indicatorsHtml += '<span class="indicator-badge">ROE+</span>';
                    
                    const entrySignal = stock.entry_point.signal;
                    const vcpDetected = stock.technical_indicators.vcp_detected;
                    let entrySignalText = entrySignal;
                    let entrySignalClass = entrySignal.toLowerCase().replace(/ /g, '-');

                    // Lógica para clarificar la señal de entrada y hacerla más descriptiva
                    if (entrySignal === 'VCP Setup' || (entrySignal === 'Consolidando' && vcpDetected)) {
                        // Unifica ambos casos (el correcto y el confuso) en una sola señal clara
                        entrySignalText = 'VCP en Formación';
                        entrySignalClass = 'vcp-setup';
                    } else if (entrySignal === 'Pivot Point') {
                        entrySignalText = 'Punto Pivote (¡Listo!)';
                    } else if (entrySignal.includes('MA-Bounce')) {
                        entrySignalText = `Rebote en MA-${entrySignal.split('-')[2]}`;
                    }

                    topPicksHtml += `
                        <div class="stock-card ${cardClass}">
                            ${perfectBadge}
                            <div class="rank">#${stock.rank}</div>
                            <div class="stock-header">
                                <div class="stock-info">
                                    <h3>${stock.symbol}</h3>
                                    <div class="company">${stock.company || ''}</div>
                                    <div class="sector">${stock.sector || ''}</div>
                                </div>
                                <div class="stock-price">
                                    <div class="price">$${stock.price.toFixed(2)}</div>
                                    <div class="minervini-score">Score: ${stock.minervini_score.toFixed(1)}</div>
                                </div>
                            </div>
                            
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <div class="stage-badge">${stock.stage_analysis.icon} ${stock.stage_analysis.stage}</div>
                                    <div class="stat-label">Stage Analysis</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stage-badge">${stock.relative_strength.strength_label}</div>
                                    <div class="stat-label">RS Rating: ${stock.relative_strength.rs_rating.toFixed(1)}</div>
                                </div>
                            </div>

                            ${indicatorsHtml ? `<div class="technical-indicators">${indicatorsHtml}</div>` : ''}
                            
                            <div class="entry-signal ${entrySignalClass}">
                                🚦 Punto de Entrada: <strong>${entrySignalText}</strong>
                            </div>
                        </div>
                    `;
                });
            } else {
                topPicksHtml += `
                    <div class="no-results">
                        <div class="no-results-icon">🎯</div>
                        <div class="no-results-title">Sin Candidatos Ideales Hoy</div>
                        <div class="no-results-subtitle">Ninguna acción pasó los 11 filtros estrictos de Minervini.</div>
                        <div class="minervini-criteria">
                            <div class="criteria-title">📋 Metodología SEPA</div>
                            <div class="criteria-section">
                                <div class="criteria-subtitle">Filtros Técnicos</div>
                                <div class="criteria-list">
                                    ${data.minervini_criteria.technical_filters.map(f => `<div class="criteria-item">${f}</div>`).join('')}
                                </div>
                            </div>
                            <div class="criteria-section">
                                <div class="criteria-subtitle">Filtros Fundamentales</div>
                                <div class="criteria-list">
                                    ${data.minervini_criteria.fundamental_filters.map(f => `<div class="criteria-item">${f}</div>`).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            topPicksHtml += '</div>';

            let marketHealthHtml = '';
            if (data.market_analysis && data.market_analysis.stage_distribution) {
                const stageDist = data.market_analysis.stage_distribution;
                const totalStocks = data.summary.total_analyzed;
                
                const stage2_total = (stageDist["Stage 2 (Uptrend)"] || 0) + (stageDist["Stage 2 (Developing)"] || 0);
                const stage1_3_total = (stageDist["Stage 1/3 (Base/Top)"] || 0);
                const stage4_total = (stageDist["Stage 4 (Decline)"] || 0);
                const other_total = totalStocks - (stage2_total + stage1_3_total + stage4_total);

                const stages = {
                    "Stage 2": { color: "#16a34a", value: stage2_total },
                    "Stage 1/3": { color: "#f59e0b", value: stage1_3_total },
                    "Stage 4": { color: "#ef4444", value: stage4_total },
                    "Other": { color: "#6b7280", value: other_total }
                };

                marketHealthHtml = `
                    <div class="market-health">
                        <div class="section-title">📊 Distribución por Stage</div>
                        <div class="chart-container">
                `;

                for (const [name, details] of Object.entries(stages)) {
                    const percentage = totalStocks > 0 ? (details.value / totalStocks) * 100 : 0;
                    marketHealthHtml += `
                        <div class="chart-bar" style="height: ${percentage > 5 ? percentage : 5}%; background-color: ${details.color};">
                            <div class="bar-value">${percentage.toFixed(0)}%</div>
                            <div class="bar-label">${name}</div>
                        </div>
                    `;
                }

                marketHealthHtml += `
                        </div>
                    </div>
                `;
            }


            const updateTime = new Date(data.timestamp).toLocaleString('es-ES', { dateStyle: 'medium', timeStyle: 'short' });
            const footerHtml = `
                <div class="last-update">
                    Última actualización: ${updateTime}<br>
                    <small>Desarrollado por 0t4c0n 🦊 | Metodología SEPA de Mark Minervini</small>
                </div>
            `;

            contentEl.innerHTML = summaryHtml + marketBreadthHtml + marketHealthHtml + topPicksHtml + footerHtml;
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>